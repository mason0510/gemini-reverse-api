<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gemini Cookie 配置</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <style>
        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #0f0f23;
            color: #e0e0e0;
            min-height: 100vh;
        }
        #app {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .header {
            background: linear-gradient(135deg, #4285f4 0%, #34a853 100%);
            color: white;
            padding: 30px;
            border-radius: 12px;
            margin-bottom: 30px;
            box-shadow: 0 4px 20px rgba(66,133,244,0.3);
        }
        .header h1 {
            margin: 0 0 10px 0;
            font-size: 28px;
        }
        .header p {
            margin: 0;
            opacity: 0.9;
        }
        .card {
            background: #1a1a2e;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            border: 1px solid #2a2a4a;
        }
        .card h2 {
            margin: 0 0 20px 0;
            font-size: 20px;
            color: #4285f4;
            border-bottom: 2px solid #4285f4;
            padding-bottom: 10px;
        }
        .status-badge {
            display: inline-block;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 500;
        }
        .status-valid {
            background: rgba(52, 168, 83, 0.2);
            color: #34a853;
            border: 1px solid #34a853;
        }
        .status-invalid {
            background: rgba(234, 67, 53, 0.2);
            color: #ea4335;
            border: 1px solid #ea4335;
        }
        .status-unknown {
            background: rgba(251, 188, 4, 0.2);
            color: #fbbc04;
            border: 1px solid #fbbc04;
        }
        .form-group {
            margin-bottom: 20px;
        }
        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #b0b0b0;
        }
        .form-input {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #3a3a5a;
            border-radius: 8px;
            font-size: 14px;
            box-sizing: border-box;
            background: #0f0f23;
            color: #e0e0e0;
            font-family: 'Monaco', 'Menlo', monospace;
        }
        .form-textarea {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #3a3a5a;
            border-radius: 8px;
            font-size: 13px;
            box-sizing: border-box;
            background: #0f0f23;
            color: #e0e0e0;
            font-family: 'Monaco', 'Menlo', monospace;
            min-height: 120px;
            resize: vertical;
        }
        .form-input:focus,
        .form-textarea:focus {
            outline: none;
            border-color: #4285f4;
            box-shadow: 0 0 0 3px rgba(66,133,244,0.2);
        }
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
        }
        .btn-primary {
            background: #4285f4;
            color: white;
        }
        .btn-primary:hover {
            background: #3367d6;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(66,133,244,0.4);
        }
        .btn-success {
            background: #34a853;
            color: white;
        }
        .btn-success:hover {
            background: #2d9249;
        }
        .btn-secondary {
            background: #5f6368;
            color: white;
        }
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        .cookie-item {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            align-items: center;
        }
        .cookie-item label {
            min-width: 180px;
            font-size: 13px;
            color: #b0b0b0;
        }
        .cookie-item input {
            flex: 1;
        }
        .help-text {
            font-size: 12px;
            color: #888;
            margin-top: 5px;
        }
        .result-box {
            background: #0a0a1a;
            border: 1px solid #3a3a5a;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 13px;
            white-space: pre-wrap;
            word-break: break-all;
        }
        .result-success {
            border-color: #34a853;
            color: #34a853;
        }
        .result-error {
            border-color: #ea4335;
            color: #ea4335;
        }
        .loading {
            text-align: center;
            padding: 20px;
            color: #888;
        }
        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #4285f4;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        .tab {
            padding: 10px 20px;
            background: #2a2a4a;
            border: none;
            border-radius: 8px;
            color: #b0b0b0;
            cursor: pointer;
            transition: all 0.2s;
        }
        .tab.active {
            background: #4285f4;
            color: white;
        }
        .tab:hover:not(.active) {
            background: #3a3a5a;
        }
    </style>
</head>
<body>
    <div id="app">
        <div class="header">
            <h1>Gemini Cookie 配置</h1>
            <p>配置Google账户Cookie以使用Gemini API服务</p>
        </div>

        <!-- Cookie状态卡片 -->
        <div class="card">
            <h2>Cookie 状态</h2>
            <div v-if="status.loading" class="loading">
                <span class="spinner"></span>检查中...
            </div>
            <div v-else>
                <p>
                    当前状态:
                    <span :class="['status-badge', statusClass]">
                        {{ statusText }}
                    </span>
                </p>
                <p v-if="status.message" style="color: #888; font-size: 14px;">
                    {{ status.message }}
                </p>
                <button class="btn btn-secondary" @click="checkStatus" style="margin-top: 10px;">
                    刷新状态
                </button>
            </div>
        </div>

        <!-- Cookie配置卡片 -->
        <div class="card">
            <h2>配置 Cookie</h2>

            <div class="tabs">
                <button :class="['tab', { active: inputMode === 'form' }]" @click="inputMode = 'form'">
                    表单输入
                </button>
                <button :class="['tab', { active: inputMode === 'json' }]" @click="inputMode = 'json'">
                    JSON输入
                </button>
                <button :class="['tab', { active: inputMode === 'txt' }]" @click="inputMode = 'txt'">
                    cookies.txt
                </button>
            </div>

            <!-- 表单输入模式 -->
            <div v-if="inputMode === 'form'">
                <div class="cookie-item">
                    <label>__Secure-1PSID *</label>
                    <input v-model="cookies.SECURE_1PSID" class="form-input" placeholder="必填">
                </div>
                <div class="cookie-item">
                    <label>__Secure-1PSIDCC</label>
                    <input v-model="cookies.SECURE_1PSIDCC" class="form-input" placeholder="可选">
                </div>
                <div class="cookie-item">
                    <label>__Secure-1PSIDTS</label>
                    <input v-model="cookies.SECURE_1PSIDTS" class="form-input" placeholder="可选，但推荐填写">
                </div>
                <p class="help-text">
                    从浏览器开发者工具 (F12) → Application → Cookies → gemini.google.com 获取
                </p>
            </div>

            <!-- JSON输入模式 -->
            <div v-if="inputMode === 'json'">
                <textarea
                    v-model="jsonInput"
                    class="form-textarea"
                    placeholder='{"__Secure-1PSID": "xxx", "__Secure-1PSIDCC": "xxx", "__Secure-1PSIDTS": "xxx"}'
                    style="min-height: 150px;"
                ></textarea>
                <p class="help-text">
                    支持JSON对象格式，键名可以是完整的Cookie名称或简写
                </p>
            </div>

            <!-- cookies.txt输入模式 -->
            <div v-if="inputMode === 'txt'">
                <textarea
                    v-model="txtInput"
                    class="form-textarea"
                    placeholder="# Netscape HTTP Cookie File
.google.com	TRUE	/	TRUE	1234567890	__Secure-1PSID	xxx
.google.com	TRUE	/	TRUE	1234567890	__Secure-1PSIDCC	xxx
.google.com	TRUE	/	TRUE	1234567890	__Secure-1PSIDTS	xxx"
                    style="min-height: 200px;"
                ></textarea>
                <p class="help-text">
                    使用 <a href="https://chromewebstore.google.com/detail/get-cookiestxt-locally/cclelndahbckbenkjhflpdbgdldlbecc" target="_blank" style="color: #4285f4;">Get cookies.txt</a> 插件导出，粘贴整个文件内容
                </p>
            </div>

            <div style="margin-top: 20px;">
                <button class="btn btn-success" @click="saveCookies" :disabled="saving">
                    {{ saving ? '保存中...' : '保存 Cookie' }}
                </button>
            </div>

            <div v-if="saveResult" :class="['result-box', saveResult.success ? 'result-success' : 'result-error']">
                {{ saveResult.message }}
            </div>
        </div>

        <!-- 测试卡片 -->
        <div class="card">
            <h2>测试 API</h2>
            <div class="form-group">
                <label class="form-label">测试提示词</label>
                <input v-model="testPrompt" class="form-input" placeholder="请说一句话">
            </div>
            <button class="btn btn-primary" @click="testApi" :disabled="testing">
                {{ testing ? '测试中...' : '发送测试请求' }}
            </button>

            <div v-if="testResult" :class="['result-box', testResult.success ? 'result-success' : 'result-error']">
                {{ testResult.message }}
            </div>
        </div>

        <!-- 使用说明 -->
        <div class="card">
            <h2>获取 Cookie 步骤</h2>
            <ol style="line-height: 2; color: #b0b0b0;">
                <li>打开 <a href="https://gemini.google.com" target="_blank" style="color: #4285f4;">gemini.google.com</a> 并登录Google账户</li>
                <li>按 F12 打开开发者工具</li>
                <li>切换到 Application (应用) 标签</li>
                <li>左侧找到 Cookies → https://gemini.google.com</li>
                <li>复制以下Cookie的值:
                    <ul>
                        <li><code style="color: #fbbc04;">__Secure-1PSID</code> (必需)</li>
                        <li><code style="color: #fbbc04;">__Secure-1PSIDCC</code> (可选)</li>
                        <li><code style="color: #fbbc04;">__Secure-1PSIDTS</code> (推荐)</li>
                    </ul>
                </li>
                <li>粘贴到上方表单并保存</li>
            </ol>
        </div>
    </div>

    <script>
        const { createApp } = Vue;

        createApp({
            data() {
                return {
                    apiBaseUrl: window.location.origin,
                    status: {
                        loading: true,
                        valid: null,
                        message: ''
                    },
                    inputMode: 'form',
                    cookies: {
                        SECURE_1PSID: '',
                        SECURE_1PSIDCC: '',
                        SECURE_1PSIDTS: ''
                    },
                    jsonInput: '',
                    txtInput: '',
                    saving: false,
                    saveResult: null,
                    testPrompt: '你好，请用一句话介绍自己',
                    testing: false,
                    testResult: null
                }
            },
            computed: {
                statusClass() {
                    if (this.status.valid === true) return 'status-valid';
                    if (this.status.valid === false) return 'status-invalid';
                    return 'status-unknown';
                },
                statusText() {
                    if (this.status.valid === true) return '有效';
                    if (this.status.valid === false) return '无效或未配置';
                    return '未知';
                }
            },
            mounted() {
                this.checkStatus();
            },
            methods: {
                async checkStatus() {
                    this.status.loading = true;
                    try {
                        const response = await axios.get(`${this.apiBaseUrl}/api/cookies/status`);
                        this.status.valid = response.data.valid;
                        this.status.message = response.data.message || '';
                    } catch (error) {
                        this.status.valid = false;
                        this.status.message = error.response?.data?.detail || error.message;
                    } finally {
                        this.status.loading = false;
                    }
                },
                parseCookiesTxt(text) {
                    // 解析 Netscape cookies.txt 格式
                    const cookies = {};
                    const lines = text.split('\n');

                    for (const line of lines) {
                        // 跳过注释和空行
                        if (line.startsWith('#') || !line.trim()) continue;

                        // Netscape格式: domain	flag	path	secure	expiration	name	value
                        const parts = line.split('\t');
                        if (parts.length >= 7) {
                            const name = parts[5];
                            const value = parts[6];

                            // 只提取我们需要的cookie
                            if (name === '__Secure-1PSID' || name === '__Secure-1PSIDCC' || name === '__Secure-1PSIDTS') {
                                cookies[name] = value;
                            }
                        }
                    }

                    return cookies;
                },
                async saveCookies() {
                    this.saving = true;
                    this.saveResult = null;

                    try {
                        let cookieData = {};

                        if (this.inputMode === 'form') {
                            if (this.cookies.SECURE_1PSID) {
                                cookieData['__Secure-1PSID'] = this.cookies.SECURE_1PSID;
                            }
                            if (this.cookies.SECURE_1PSIDCC) {
                                cookieData['__Secure-1PSIDCC'] = this.cookies.SECURE_1PSIDCC;
                            }
                            if (this.cookies.SECURE_1PSIDTS) {
                                cookieData['__Secure-1PSIDTS'] = this.cookies.SECURE_1PSIDTS;
                            }
                        } else if (this.inputMode === 'json') {
                            cookieData = JSON.parse(this.jsonInput);
                        } else if (this.inputMode === 'txt') {
                            cookieData = this.parseCookiesTxt(this.txtInput);
                            if (Object.keys(cookieData).length === 0) {
                                this.saveResult = { success: false, message: '未能从cookies.txt中解析到有效的Cookie' };
                                this.saving = false;
                                return;
                            }
                        }

                        if (!cookieData['__Secure-1PSID'] && !cookieData['SECURE_1PSID']) {
                            this.saveResult = { success: false, message: '__Secure-1PSID 是必填项' };
                            return;
                        }

                        const response = await axios.post(
                            `${this.apiBaseUrl}/api/cookies`,
                            { cookies: cookieData },
                            { headers: { 'Content-Type': 'application/json' } }
                        );

                        this.saveResult = {
                            success: true,
                            message: response.data.message || 'Cookie 保存成功！'
                        };
                        this.checkStatus();
                    } catch (error) {
                        let errorMsg = error.message;
                        if (error.response?.data?.detail) {
                            errorMsg = error.response.data.detail;
                        }
                        this.saveResult = { success: false, message: `保存失败: ${errorMsg}` };
                    } finally {
                        this.saving = false;
                    }
                },
                async testApi() {
                    this.testing = true;
                    this.testResult = null;

                    try {
                        const response = await axios.post(
                            `${this.apiBaseUrl}/v1/generate`,
                            { prompt: this.testPrompt },
                            { headers: { 'Content-Type': 'application/json' } }
                        );

                        this.testResult = {
                            success: true,
                            message: `响应: ${response.data.text}`
                        };
                    } catch (error) {
                        let errorMsg = error.message;
                        if (error.response?.data?.detail) {
                            errorMsg = error.response.data.detail;
                        }
                        this.testResult = { success: false, message: `测试失败: ${errorMsg}` };
                    } finally {
                        this.testing = false;
                    }
                }
            }
        }).mount('#app');
    </script>
</body>
</html>
