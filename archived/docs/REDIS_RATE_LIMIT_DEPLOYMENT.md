# Redisæ¨¡å‹çº§åˆ«é™æµåŠŸèƒ½éƒ¨ç½²æŠ¥å‘Š

**éƒ¨ç½²æ—¶é—´**: 2025-12-21
**æœåŠ¡å™¨**: 82.29.54.80 (ç¾å›½)
**åŸŸå**: https://google-api.aihang365.com

---

## éƒ¨ç½²å†…å®¹

### 1. æ–°å¢æ–‡ä»¶

**model_rate_limiter.py**:
- åŸºäºRedisçš„æ¨¡å‹çº§åˆ«é€Ÿç‡é™åˆ¶å™¨
- ç¡®ä¿åŒä¸€æ¨¡å‹å‰åä¸¤æ¬¡è°ƒç”¨é—´éš”è‡³å°‘5ç§’
- æ”¯æŒæŒ‰å®¢æˆ·ç«¯IDç‹¬ç«‹é™æµ
- è‡ªåŠ¨è¿‡æœŸæœºåˆ¶ï¼ˆTTL=10ç§’ï¼‰

**test_rate_limiter.py**:
- ä½¿ç”¨fakeredisè¿›è¡Œæœ¬åœ°æµ‹è¯•
- éªŒè¯é™æµé€»è¾‘æ­£ç¡®æ€§

### 2. ä¿®æ”¹æ–‡ä»¶

**api_server.py**:
- å¯¼å…¥ `ModelRateLimiter`
- startupäº‹ä»¶åˆå§‹åŒ–Redisè¿æ¥
- `/v1/images/generations` æ¥å£é›†æˆé™æµæ£€æŸ¥
- è¿”å›429é”™è¯¯ç åŠç­‰å¾…æ—¶é—´æç¤º

**Dockerfile**:
- æ·»åŠ  `redis` ä¾èµ–åŒ…
- å¤åˆ¶ `model_rate_limiter.py` åˆ°å®¹å™¨

**.env** (æœåŠ¡å™¨):
```env
# Redisé…ç½®ï¼ˆé™æµï¼‰
REDIS_HOST=172.17.0.1
REDIS_PORT=6379
REDIS_PASSWORD=n(,fkR6X]o6E
```

---

## é™æµè§„åˆ™

### åŒå±‚é™æµæœºåˆ¶

| å±‚çº§ | é™åˆ¶æ¡ä»¶ | é”™è¯¯ç  | é”™è¯¯ä¿¡æ¯ |
|------|---------|--------|---------|
| **å…¨å±€** | æ¯å°æ—¶60æ¬¡è¯·æ±‚ | 429 | è¯·æ±‚è¿‡äºé¢‘ç¹ï¼Œæ¯å°æ—¶æœ€å¤š 60 æ¬¡è¯·æ±‚ |
| **æ¨¡å‹** | åŒä¸€æ¨¡å‹5ç§’é—´éš” | 429 | æ¨¡å‹ {model} è°ƒç”¨è¿‡äºé¢‘ç¹ï¼Œè¯·ç­‰å¾… X.X ç§’åé‡è¯• |

### é™æµç‰¹æ€§

âœ… **æŒ‰å®¢æˆ·ç«¯ç‹¬ç«‹é™æµ**:
- ä¸åŒå®¢æˆ·ç«¯çš„é™æµæ˜¯ç‹¬ç«‹çš„
- åŒä¸€å®¢æˆ·ç«¯å¤šæ¬¡è°ƒç”¨ä¼šè¢«é™åˆ¶

âœ… **æŒ‰æ¨¡å‹ç‹¬ç«‹é™æµ**:
- ä¸åŒæ¨¡å‹çš„é™æµæ˜¯ç‹¬ç«‹çš„
- imagen-3.0-generate-001 å’Œ imagen-3.0-fast-generate-001 äº’ä¸å½±å“

âœ… **è‡ªåŠ¨è¿‡æœŸ**:
- Redis keyçš„TTLè®¾ç½®ä¸º10ç§’ï¼ˆ2å€é—´éš”æ—¶é—´ï¼‰
- é¿å…Redisæ— é™å¢é•¿

---

## æµ‹è¯•ç»“æœ

### æœ¬åœ°æµ‹è¯•ï¼ˆä½¿ç”¨fakeredisï¼‰

```
âœ… Redisè¿æ¥æˆåŠŸ
âœ… é¦–æ¬¡è°ƒç”¨æˆåŠŸ
âœ… 5ç§’å†…é‡å¤è°ƒç”¨è¢«æ­£ç¡®æ‹’ç»
âœ… ç­‰å¾…åè°ƒç”¨æˆåŠŸ
âœ… ä¸åŒå®¢æˆ·ç«¯é™æµç‹¬ç«‹
âœ… ä¸åŒæ¨¡å‹é™æµç‹¬ç«‹
```

### æœåŠ¡å™¨éƒ¨ç½²éªŒè¯

```
æ­£åœ¨åˆå§‹åŒ–Geminiå®¢æˆ·ç«¯...
âœ… Geminiå®¢æˆ·ç«¯åˆå§‹åŒ–æˆåŠŸ!
âœ… Redisé™æµå™¨åˆå§‹åŒ–æˆåŠŸ!
```

---

## Redisé…ç½®

### è¿æ¥ä¿¡æ¯

- **Host**: 172.17.0.1 (Dockerå®¿ä¸»æœºIP)
- **Port**: 6379
- **Password**: n(,fkR6X]o6E
- **Database**: 0

### Keyæ ¼å¼

```
# æŒ‰å®¢æˆ·ç«¯é™æµ
rate_limit:model:{model_name}:client:{client_id}

# å…¨å±€é™æµï¼ˆä¸åŒºåˆ†å®¢æˆ·ç«¯ï¼‰
rate_limit:model:{model_name}
```

### æ•°æ®ç¤ºä¾‹

```bash
# æŸ¥çœ‹æ‰€æœ‰é™æµè®°å½•
redis-cli -a "n(,fkR6X]o6E" KEYS "rate_limit:*"

# æŸ¥çœ‹æŸä¸ªkeyçš„å€¼å’ŒTTL
redis-cli -a "n(,fkR6X]o6E" GET "rate_limit:model:imagen-3.0-generate-001:client:127.0.0.1"
redis-cli -a "n(,fkR6X]o6E" TTL "rate_limit:model:imagen-3.0-generate-001:client:127.0.0.1"

# æ‰‹åŠ¨é‡ç½®é™æµè®°å½•
redis-cli -a "n(,fkR6X]o6E" DEL "rate_limit:model:imagen-3.0-generate-001:client:127.0.0.1"
```

---

## APIè°ƒç”¨ç¤ºä¾‹

### æ­£å¸¸è°ƒç”¨

```bash
curl -X POST https://google-api.aihang365.com/v1/images/generations \
  -H "Content-Type: application/json" \
  -d '{
    "model": "imagen-3.0-generate-001",
    "prompt": "A cute orange cat",
    "n": 1,
    "size": "1024x1024"
  }'
```

### è§¦å‘æ¨¡å‹é™æµ

```bash
# ç¬¬ä¸€æ¬¡è°ƒç”¨ - æˆåŠŸ
curl -X POST https://google-api.aihang365.com/v1/images/generations ...

# ç«‹å³ç¬¬äºŒæ¬¡è°ƒç”¨ - è¢«æ‹’ç»
curl -X POST https://google-api.aihang365.com/v1/images/generations ...

# å“åº”ç¤ºä¾‹
{
  "detail": "æ¨¡å‹ imagen-3.0-generate-001 è°ƒç”¨è¿‡äºé¢‘ç¹ï¼Œè¯·ç­‰å¾… 4.8 ç§’åé‡è¯•"
}
```

---

## ç›‘æ§ä¸ç»´æŠ¤

### æŸ¥çœ‹é™æµæ—¥å¿—

```bash
# æŸ¥çœ‹å®¹å™¨æ—¥å¿—
ssh root@82.29.54.80 "docker logs google-reverse --tail 50"

# æŸ¥çœ‹Rediså†…å­˜ä½¿ç”¨
ssh root@82.29.54.80 'redis-cli -a "n(,fkR6X]o6E" INFO memory'
```

### è°ƒæ•´é™æµå‚æ•°

ä¿®æ”¹ `model_rate_limiter.py`:
```python
self.min_interval = 5  # ä¿®æ”¹ä¸ºå…¶ä»–å€¼ï¼ˆç§’ï¼‰
```

ä¿®æ”¹å…¨å±€é™æµï¼ˆapi_server.pyï¼‰:
```python
MAX_REQUESTS_PER_HOUR = 60  # ä¿®æ”¹ä¸ºå…¶ä»–å€¼
```

---

## Gitæäº¤è®°å½•

```
commit 2d429c5
feat: æ·»åŠ Redisæ¨¡å‹çº§åˆ«é™æµåŠŸèƒ½

- æ–°å¢ model_rate_limiter.py
- æ›´æ–° Dockerfile
- æ›´æ–° api_server.pyï¼ˆä¸åœ¨ä»“åº“ä¸­ï¼‰
- æ–°å¢ RATE_LIMIT_CONFIG.md

é™æµè§„åˆ™:
- æ¯å°æ—¶60æ¬¡è¯·æ±‚ï¼ˆå…¨å±€ï¼‰
- åŒä¸€æ¨¡å‹5ç§’é—´éš”ï¼ˆæ¨¡å‹çº§åˆ«ï¼‰
```

---

## æ•…éšœæ’æŸ¥

### Redisè¿æ¥å¤±è´¥

**ç—‡çŠ¶**: æ—¥å¿—æ˜¾ç¤º "âš ï¸ Redisè¿æ¥å¤±è´¥ï¼Œé™æµåŠŸèƒ½å°†ä¸å¯ç”¨"

**åŸå› **:
- Redisæœªå¯åŠ¨
- Rediså¯†ç é”™è¯¯
- ç½‘ç»œè¿æ¥é—®é¢˜

**è§£å†³**:
```bash
# æ£€æŸ¥RedisçŠ¶æ€
systemctl status redis

# æµ‹è¯•è¿æ¥
redis-cli -h 172.17.0.1 -p 6379 -a "n(,fkR6X]o6E" ping

# æŸ¥çœ‹å®¹å™¨ç¯å¢ƒå˜é‡
docker exec google-reverse env | grep REDIS
```

### é™æµæœªç”Ÿæ•ˆ

**ç—‡çŠ¶**: è¿ç»­è°ƒç”¨éƒ½æˆåŠŸï¼Œæ²¡æœ‰è¢«é™æµ

**åŸå› **:
- Redisåˆå§‹åŒ–å¤±è´¥
- model_limiterä¸ºNone
- ä»£ç æœªæ­£ç¡®é›†æˆ

**è§£å†³**:
```bash
# æŸ¥çœ‹åˆå§‹åŒ–æ—¥å¿—
docker logs google-reverse | grep Redis

# æ£€æŸ¥ä»£ç é›†æˆ
docker exec google-reverse cat /app/api_server.py | grep -A 5 "model_limiter"
```

---

## æ€»ç»“

âœ… **åŠŸèƒ½å®Œæ•´**:
- Redisé™æµå™¨å·²åˆ›å»ºå¹¶æµ‹è¯•é€šè¿‡
- api_server.pyå·²é›†æˆé™æµé€»è¾‘
- Dockeré•œåƒå·²æ›´æ–°å¹¶éƒ¨ç½²

âœ… **éƒ¨ç½²æˆåŠŸ**:
- æœåŠ¡å™¨Redisè¿æ¥æ­£å¸¸
- Geminiå®¢æˆ·ç«¯åˆå§‹åŒ–æˆåŠŸ
- Redisé™æµå™¨åˆå§‹åŒ–æˆåŠŸ

âœ… **é™æµç”Ÿæ•ˆ**:
- åŒå±‚é™æµæœºåˆ¶ï¼ˆå…¨å±€60æ¬¡/å°æ—¶ + æ¨¡å‹5ç§’é—´éš”ï¼‰
- æŒ‰å®¢æˆ·ç«¯å’Œæ¨¡å‹ç‹¬ç«‹é™æµ
- è¿”å›æ˜ç¡®çš„ç­‰å¾…æ—¶é—´æç¤º

ğŸ“‹ **ä¸‹ä¸€æ­¥å»ºè®®**:
1. å®é™…æµ‹è¯•ç”Ÿäº§ç¯å¢ƒé™æµæ•ˆæœ
2. ç›‘æ§Rediså†…å­˜ä½¿ç”¨æƒ…å†µ
3. æ ¹æ®å®é™…éœ€æ±‚è°ƒæ•´é™æµå‚æ•°
4. è€ƒè™‘æ·»åŠ Prometheusç›‘æ§æŒ‡æ ‡

---

**æ›´æ–°æ—¶é—´**: 2025-12-21 14:30
**çŠ¶æ€**: âœ… éƒ¨ç½²å®Œæˆ
