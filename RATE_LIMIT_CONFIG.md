# 频率限制与反检测配置

## 🎯 功能概述

为避免触发Google风控系统，已添加以下反检测措施：

1. **请求频率限制** - 控制每小时请求次数
2. **随机延迟** - 模拟人类操作间隔
3. **浏览器User-Agent模拟** - 伪装为真实浏览器

---

## ⚙️ 环境变量配置

在 `.env` 文件中添加以下配置（可选，有默认值）：

```bash
# 频率限制配置
MAX_REQUESTS_PER_HOUR=60    # 每小时最大请求数（默认60次）
MIN_DELAY=1.0                # 最小延迟秒数（默认1秒）
MAX_DELAY=3.0                # 最大延迟秒数（默认3秒）
```

---

## 📊 默认配置说明

| 配置项 | 默认值 | 说明 | 推荐范围 |
|--------|--------|------|---------|
| `MAX_REQUESTS_PER_HOUR` | 60 | 每小时最大请求数 | 30-120 |
| `MIN_DELAY` | 1.0秒 | 每次请求最小延迟 | 0.5-2.0秒 |
| `MAX_DELAY` | 3.0秒 | 每次请求最大延迟 | 2.0-5.0秒 |

**建议策略**:
- ✅ **保守模式**: 30次/小时，2-5秒延迟（最安全）
- ✅ **平衡模式**: 60次/小时，1-3秒延迟（推荐）⭐
- ⚠️ **激进模式**: 120次/小时，0.5-2秒延迟（有风险）

---

## 🔧 工作原理

### 1. 频率限制

```
每个客户端IP独立跟踪：
- 记录最近1小时内的所有请求时间戳
- 超过限制返回 429 Too Many Requests
- 自动滑动窗口（1小时前的记录自动清理）
```

### 2. 随机延迟

```
每次请求前随机延迟：
- 延迟时间 = random(MIN_DELAY, MAX_DELAY)
- 模拟人类思考和操作时间
- 避免机器般的固定频率
```

### 3. User-Agent模拟

```
内置5种真实浏览器User-Agent：
✅ Chrome (Mac/Windows/Linux)
✅ Safari (Mac)
✅ Firefox (Windows)

每次初始化客户端时随机选择一个
```

---

## 🚨 HTTP 429 错误处理

当请求过于频繁时，API会返回：

```json
{
  "detail": "请求过于频繁，每小时最多 60 次请求"
}
```

**客户端应对策略**:
1. 等待一段时间后重试
2. 降低请求频率
3. 使用多个客户端IP分散请求

---

## 📋 受影响的接口

以下接口已添加频率限制和延迟：

| 接口 | 说明 | 状态 |
|------|------|------|
| `/v1/chat/completions` | OpenAI聊天接口 | ✅ 已保护 |
| `/v1/generate` | 简化生成接口 | ✅ 已保护 |
| `/v1/images/generations` | 图片生成接口 | ✅ 已保护 |
| `/gemini/v1beta/models/{model}:generateContent` | Gemini原生接口 | ✅ 已保护 |
| `/v1/audio/speech` | TTS语音接口 | ❌ 不需要（官方API） |
| `/health` | 健康检查 | ❌ 不需要 |
| `/api/info` | API信息 | ❌ 不需要 |

---

## 🔍 日志监控

服务启动时会显示：

```
正在初始化Gemini客户端...
🌐 使用 User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7)...
✅ Gemini客户端初始化成功!
```

---

## ⚠️ Cookie过期处理

**当前状态**: Cookie已过期，需要更新

**更新步骤**:
1. 使用浏览器登录 https://gemini.google.com
2. 打开开发者工具 (F12) → Application → Cookies
3. 找到以下Cookie值：
   - `__Secure-1PSID`
   - `__Secure-1PSIDCC`
   - `__Secure-1PSIDTS`
4. 更新服务器 `.env` 文件
5. 重启容器：
   ```bash
   docker restart google-reverse
   ```

---

## 🎯 降低被检测风险的最佳实践

1. **控制使用频率**
   - ✅ 避免短时间内大量测试
   - ✅ 生产环境限制在30-60次/小时
   - ❌ 不要连续快速调用

2. **分散请求来源**
   - ✅ 使用CDN/反向代理分散IP
   - ✅ 多个服务器轮换
   - ❌ 不要所有请求来自同一IP

3. **Cookie维护**
   - ✅ 定期检查Cookie有效性
   - ✅ 发现过期立即更新
   - ⚠️ Cookie通常1-2周过期
   - ❌ 不要在多个服务器共用同一Cookie

4. **请求特征模拟**
   - ✅ 已自动添加随机延迟
   - ✅ 已自动模拟浏览器User-Agent
   - ✅ 每次请求间隔1-3秒
   - ❌ 不要移除这些保护措施

---

## 📈 性能影响

| 指标 | 无保护 | 有保护 | 影响 |
|------|--------|--------|------|
| **单次请求延迟** | ~1秒 | 2-4秒 | +1-3秒 |
| **并发能力** | 不限 | 60次/小时/IP | 受限 |
| **被检测风险** | 高 | 低 | 显著降低 |

**权衡**:
- ✅ 牺牲了一些性能和吞吐量
- ✅ 换取了稳定性和持久性
- ✅ 避免Cookie频繁失效

---

## 🔄 如何调整配置

### 场景1: 需要更高频率（风险较大）

```bash
# .env
MAX_REQUESTS_PER_HOUR=120
MIN_DELAY=0.5
MAX_DELAY=2.0
```

### 场景2: 追求稳定性（推荐）

```bash
# .env
MAX_REQUESTS_PER_HOUR=30
MIN_DELAY=2.0
MAX_DELAY=5.0
```

### 场景3: 内部测试环境（可取消限制）

```bash
# .env
MAX_REQUESTS_PER_HOUR=1000
MIN_DELAY=0.1
MAX_DELAY=0.2
```

修改后重启容器生效：
```bash
docker restart google-reverse
```

---

## 📝 更新日志

### v1.2 (2025-12-19)
- ✅ 添加请求频率限制（每IP每小时60次）
- ✅ 添加随机延迟（1-3秒）
- ✅ 添加浏览器User-Agent模拟
- ✅ 所有Cookie接口已保护
- ⚠️ Cookie已过期，需要更新

---

**维护者**: Mason
**最后更新**: 2025-12-19
**服务器**: 82.29.54.80:8100
